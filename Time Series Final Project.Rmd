---
title: "Time Series Final Project"
output: html_document
date: "2023-11-20"
---

```{r setup, include = FALSE}

# Set up the default parameters
# 1. The code block will be shown in the document
# 2. set up figure display size
# 3. turn off all the warnings and messages

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width = 12, fig.height = 8)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```


```{r library}
library(zoo)
library(lubridate)
library(mgcv)
library(TSA)
library(dynlm)
library(tseries)
library(vars)
library(rugarch)
library(forecast)
library(wesanderson)
library(knitr)
```

```{r load data}
#Read in data, split into full and abridged data
full.data<-read.csv("jena_climate_2009_2016.csv")
full.data$Date.Time <- as.POSIXct(full.data$Date.Time, format="%d.%m.%Y %H:%M:%S")
full.data$Date <- as.Date(full.data$Date.Time)
full.data$Hour <- hour(full.data$Date.Time)
```


```{r}
df <- data.frame(datetime = full.data$Date.Time, date = full.data$Date, hour = full.data$Date.Time, pressure <- full.data$p..mbar., temperature = full.data$Tpot..K., humidity = full.data$sh..g.kg.)
```

```{r}
data.daily <- aggregate(df[-c(1,2,3)], list(df$date), mean)
colnames(data.daily) <- c("date", "pressure", "temperature", "humidity")
data.daily$month <- month(data.daily$date)

data.hourly <- aggregate(df[-c(1,2,3)], list(df$date, df$hour), mean)
colnames(data.hourly) <- c("date", "hour", "pressure", "temperature", "humidity")
data.hourly$month <- month(data.hourly$date)

daily.training.data <- data.daily[1:2879,]
daily.training.date <- data.daily[1:2879,1]
daily.testing.data <- data.daily[2880:2921,]
daily.testing.date <- data.daily[2880:2921,1]
daily.training.month <- data.daily[1:2879,5]
daily.testing.month <- data.daily[2880:2921,5]

test.yday <- yday(daily.testing.date[1])

daily.pressure.ts <- ts(data.daily$pressure, frequency = 365, start=c(2009,1))
daily.temperature.ts <- ts(data.daily$temperature, frequency = 365, start=c(2009,1))
daily.humidity.ts <- ts(data.daily$humidity, frequency = 365, start=c(2009,1))

daily.pressure.train.ts <- ts(daily.training.data$pressure, frequency = 365, start=c(2009,1))
daily.temp.train.ts <- ts(daily.training.data$temperature, frequency = 365, start=c(2009,1))
daily.humidity.train.ts <- ts(daily.training.data$humidity, frequency = 365, start=c(2009,1))

daily.pressure.test.ts <- ts(daily.testing.data$pressure, frequency = 365, start=c(2016,test.yday))
daily.temp.test.ts <- ts(daily.testing.data$temperature, frequency = 365, start=c(2016,test.yday))
daily.humidity.test.ts <- ts(daily.testing.data$humidity, frequency = 365, start=c(2016,test.yday))
```


```{r}
ts.plot(daily.pressure.train.ts, type="l", main=paste("pressure"),ylab="")
ts.plot(daily.temp.train.ts, type="l", main=paste("temperature"),ylab="")
ts.plot(daily.humidity.train.ts, type="l", main=paste("humidity"),ylab="")
```

```{r}
stats::acf(as.matrix(daily.training.data[-c(1,5)]))
```

## Non-parametric trend and ANOVA monthly seasonality

```{r}
daily.time.pts <- c(1:length(daily.training.date))
daily.time.pts <- c(daily.time.pts - min(daily.time.pts))/max(daily.time.pts)
```

### Pressure

```{r}
gam1.fitted = gam(daily.pressure.train.ts ~ s(daily.time.pts)+factor(daily.training.month))
summary(gam1.fitted)
```

### Temperature
```{r}
gam2.fitted = gam(daily.temp.train.ts ~ s(daily.time.pts)+factor(daily.training.month))
summary(gam2.fitted)
```

### Humidity

```{r}
gam3.fitted = gam(daily.humidity.train.ts ~ s(daily.time.pts)+factor(daily.training.month))
summary(gam3.fitted)
```
*Response*: Based on the model outputs above we can conclude the following: for all 3 models the monthly seasonality is significant. Trend is also significant for all 3 models.  

```{r}
gam1.fitted.ts = ts(fitted(gam1.fitted), freq = 365, start = c(2009,1))
plot(daily.pressure.train.ts,ylab="Pressure", col="black")
lines(gam1.fitted.ts, lwd=1.5,col="purple")
legend(x="topleft", legend=c("Pressure", "Non-parametric trend and monthly seasonality using ANOVA"), fill = c("black", "purple"), cex=0.7, lty=1)

gam2.fitted.ts = ts(fitted(gam2.fitted), freq = 365, start = c(2009,1))
plot(daily.temp.train.ts,ylab="Temperature", col="black")
lines(gam2.fitted.ts, lwd=1.5,col="purple")
legend(x="topleft", legend=c("Temperature", "Non-parametric trend and monthly seasonality using ANOVA"), fill = c("black", "purple"), cex=0.7, lty=1)

gam3.fitted.ts = ts(fitted(gam3.fitted), freq = 365, start = c(2009,1))
plot(daily.humidity.train.ts,ylab="Humidity", col="black")
lines(gam3.fitted.ts, lwd=1.5,col="purple")
legend(x="topleft", legend=c("Humidity", "Non-parametric trend and monthly seasonality using ANOVA"), fill = c("black", "purple"), cex=0.7, lty=1)
```

*Response*: Looking at the plots above, we can see that for all 3 time series we were able to capture the main pattern, especially it is visible for temperature and humidity time series that have clear seasonality patterns.

### Residual Analysis

```{r}
par(mfrow=c(2,2))
ts.plot(ts(gam1.fitted$residuals, frequency = 365, start = c(2009,1)), main="Pressure Residuals")
acf(gam1.fitted$residuals, lag.max = 40, main="ACF of Pressure Residuals")
acf(gam1.fitted$residuals^2, lag.max = 40, main="ACF of Squared Pressure Residuals")
pacf(gam1.fitted$residuals, lag.max = 40, main="PACF of Pressure Residuals")
adf.test(gam1.fitted$residuals, k=1)
adf.test(gam1.fitted$residuals, k=5)
kpss.test(gam1.fitted$residuals)
```

*Response*: Looking at the time series plot variance seems to be somewhat constant, howevered acf of squared residuals shows some correlation. On the ACF plot we see that most of the values after lag 7 are within the confidence band, which indicates stationarity. Results of Augmented Dickey-Fuller Test and KPSS test also suggest stationary data. To conclude, based on time series plot, ACF plot and results of the test for stationarity we conclude that the residuals of the first model are stationary and there's heteroscedasticity present.  

```{r}
par(mfrow=c(2,2))
ts.plot(ts(gam2.fitted$residuals, frequency = 365, start = c(2009,1)), main="Temperature Residuals")
acf(gam2.fitted$residuals, lag.max = 40, main="ACF of Temperature Residuals")
acf(gam2.fitted$residuals^2, lag.max = 40, main="ACF of Squared Temperature Residuals")
pacf(gam2.fitted$residuals, lag.max = 40, main="PACF of Temperature Residuals")
adf.test(gam2.fitted$residuals, k=1)
adf.test(gam2.fitted$residuals, k=5)
kpss.test(gam2.fitted$residuals)
```

*Response*: Looking at the time series plot variance seems to be constant and squared residuals also show the same result. On the ACF plot we see that most of the values after lag 8 are within the confidence band, which indicates stationarity. However, there are might be a seasonal pattern left in the residuals. Results of Augmented Dickey-Fuller Test and KPSS test suggest stationary data. Based on time series plot, ACF plot and results of the test for stationarity we conclude that the residuals of the second model seem to be stationary and the variance seem to be constant. 

```{r}
par(mfrow=c(2,2))
ts.plot(ts(gam3.fitted$residuals, frequency = 365, start = c(2009,1)), main="Humidity Residuals")
acf(gam3.fitted$residuals, lag.max = 40, main="ACF of Humidity Residuals")
acf(gam3.fitted$residuals^2, lag.max = 40, main="ACF of Squared Humidity Residuals")
pacf(gam3.fitted$residuals, lag.max = 40, main="PACF of Humidity Residuals")
adf.test(gam3.fitted$residuals, k=1)
adf.test(gam3.fitted$residuals, k=5)
kpss.test(gam3.fitted$residuals)
```
*Response*: Looking at the time series plot and ACF plot of Squared residuals we conclude that the variance isn't constant. On the ACF plot we see a seasonal pattern, which indicates non stationarity. However, results of Augmented Dickey-Fuller Test and KPSS both test suggest stationary data. So there is not enough evidence to indicate non stationary data. To conclude, based on time series plot, ACF plot and results of the test for stationarity we conclude that the residuals of the third model are close to stationary, but we cannot say for sure. There's also heteroscedasticity in the residuals.

### Predictions

#### Pressure
```{r}

prediction.h.gam <- c()
prediction.p.gam <- c()
prediction.t.gam <- c()

for (i in 1:6) {
  data <- daily.training.data
  new.data <- daily.testing.data[c((1 + (i - 1)*7):(i*7)),]
  if (i >= 2) {
    data <- rbind(data, daily.testing.data[c(1:((i - 1)*7)),])
  }
  tps <- c(1:nrow(data.daily))
  tps <- c(tps - min(tps))/max(tps)
  data$tps <- tps[1:nrow(data)]
  new.data$tps <- tps[(nrow(data) + 1):(nrow(data) + 7)]
  
  gam.p <- gam(pressure ~ s(tps)+factor(month), data = data)
  predict.p <- predict(gam.p, new.data, se.fit = TRUE)
  lb <- predict.p$fit - 1.96 * predict.p$se.fit
  ub <- predict.p$fit + 1.96 * predict.p$se.fit
  temp <- data.frame('prediction' = predict.p$fit, 'lower' = lb, 'upper' = ub)
  prediction.p.gam <- rbind(prediction.p.gam,temp)
  
  gam.t <- gam(temperature ~ s(tps)+factor(month), data = data)
  predict.t <- predict(gam.t, new.data, se.fit = TRUE)
  lb <- predict.t$fit - 1.96 * predict.t$se.fit
  ub <- predict.t$fit + 1.96 * predict.t$se.fit
  temp <- data.frame('prediction' = predict.t$fit, 'lower' = lb, 'upper' = ub)
  prediction.t.gam <- rbind(prediction.t.gam,temp)
  
  gam.h <- gam(humidity ~ s(tps)+factor(month), data = data)
  predict.h <- predict(gam.h, new.data, se.fit = TRUE)
  lb <- predict.h$fit - 1.96 * predict.h$se.fit
  ub <- predict.h$fit + 1.96 * predict.h$se.fit
  temp <- data.frame('prediction' = predict.h$fit, 'lower' = lb, 'upper' = ub)
  prediction.h.gam <- rbind(prediction.h.gam,temp)
}

gam.prediction <- data.frame('date' = daily.testing.data$date,
                             'pressure' = prediction.p.gam,
                             'temperature' = prediction.t.gam,
                             'humidity' = prediction.h.gam,
                             'month' = daily.testing.data$month)

plot(daily.testing.data$date, daily.testing.data$pressure, type = 'l', ylim = c(980,1020), main = 'Pressure Prediction', ylab = 'Pressure', xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.p.gam$prediction, pch = 1, col = 'red', ylim = c(980,1020), ylab = '', cex = 0.8, xlab = 'Date')

plot(daily.testing.data$date, daily.testing.data$temperature, ylim = c(268,285), main = 'Temperature Prediction', ylab = 'Temperature', type = 'l', xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.t.gam$prediction, col = 'red', ylim = c(268,285),ylab = '', pch = 1, cex = 0.8, xlab = 'Date')

plot(daily.testing.data$date, daily.testing.data$humidity, ylim = c(2,6), main = 'Humidity Prediction',ylab = 'Humidity', type = 'l', xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.h.gam$prediction, col = 'red', ylim = c(2,6),ylab = '', pch = 1, cex = 0.8, xlab = 'Date')
```


## ARMA modeling

### Pressure
```{r}
nfit = length(daily.testing.date)
harmonic.train <- cbind(sin(daily.training.month*2*pi/12),cos(daily.training.month*2*pi/12))
harmonic.test <- cbind(sin(daily.testing.month*2*pi/12),cos(daily.testing.month*2*pi/12))
harmonic.all <- rbind(harmonic.train, harmonic.test)
```

```{r}
## Fit an ARMA model to the residuals

#Iterative function
test_modelA <- function(p,d,q,train.data){
  mod = Arima(train.data,order=c(p,d,q),xreg=as.matrix(harmonic.train))
  current.aic = AIC(mod)
  df = data.frame(p,d,q,current.aic)
  names(df) <- c("p","d","q","AIC")
  return(df)
}
```

```{r}
#orders = data.frame(Inf,Inf,Inf, Inf)
#names(orders) <- c("p","d","q","AIC")

#Orders for Arima for Pressure
#for (p in 0:9){
#    for (q in 0:9) {
#      for (d in 0:1) {
#          possibleError <- tryCatch(
#          orders<-rbind(orders,test_modelA(p,d,q,daily.pressure.train.ts)),
#          error=function(e) e
#          )
#          if(inherits(possibleError, "error")) next
#      }
#  }
#}
#orders <- orders[order(-orders$AIC),]
#tail(orders,5)
```

```{r}
arma.pressure <- Arima(daily.pressure.train.ts,order=c(4,1,6),xreg=as.matrix(harmonic.train))
arma.pressure
```

```{r}
## compute the test statistics
testval <-
  as.numeric(arma.pressure$coef) / as.numeric(sqrt(diag(arma.pressure$var.coef)))

## print t-statistic
print(testval)

## print p-values
print(2*(1-pnorm(abs(testval))))

## print significant coefficients for significance level 0.05
which(abs(testval)>qnorm((1-0.05/2)))
```

```{r}
par(mfrow=c(2,2))
ts.plot(ts(residuals(arma.pressure), frequency = 365, start = c(2009,1)))
acf(residuals(arma.pressure), lag.max = 40)
acf(residuals(arma.pressure)^2, lag.max = 40)
qqnorm(residuals(arma.pressure))
qqline(residuals(arma.pressure))

#perform shapiro-wilk test
shapiro.test(residuals(arma.pressure))
```

### Temperature
```{r}
#orders = data.frame(Inf,Inf,Inf, Inf)
#names(orders) <- c("p","d","q","AIC")

#Orders for Arima for Temperature
#for (p in 0:9){
#    for (q in 0:9) {
#      for (d in 0:1) {
#          possibleError <- tryCatch(
#          orders<-rbind(orders,test_modelA(p,d,q,daily.temp.train.ts)),
#          error=function(e) e
#          )
#          if(inherits(possibleError, "error")) next
#      }
#  }
#}
#orders <- orders[order(-orders$AIC),]
#tail(orders,5)
```

```{r}
arma.temp <- Arima(daily.temp.train.ts,order=c(8,1,4),xreg=as.matrix(harmonic.train))
arma.temp
```

```{r}
## compute the test statistics
testval <-
  as.numeric(arma.temp$coef) / as.numeric(sqrt(diag(arma.temp$var.coef)))

## print t-statistic
print(testval)

## print p-values
print(2*(1-pnorm(abs(testval))))

## print significant coefficients for significance level 0.05
which(abs(testval)>qnorm((1-0.05/2)))
```

```{r}
par(mfrow=c(2,2))
ts.plot(ts(residuals(arma.temp), frequency = 365, start = c(2009,1)))
acf(residuals(arma.temp), lag.max = 40)
acf(residuals(arma.temp)^2, lag.max = 40)
qqnorm(residuals(arma.temp))
qqline(residuals(arma.temp))

#perform shapiro-wilk test
shapiro.test(residuals(arma.temp))
```

### Humidity
```{r}
#Orders for Arima for Humidity
#orders = data.frame(Inf,Inf,Inf, Inf)
#names(orders) <- c("p","d","q","AIC")

#for (p in 0:9){
#    for (q in 0:9) {
#      for (d in 0:1) {
#          possibleError <- tryCatch(
#          orders<-rbind(orders,test_modelA(p,d,q,daily.humidity.train.ts)),
#          error=function(e) e
#          )
#          if(inherits(possibleError, "error")) next
#      }
#  }
#}
#orders <- orders[order(-orders$AIC),]
#tail(orders,5)
```

```{r}
arma.humidity <- Arima(daily.humidity.train.ts,order=c(5,0,1),xreg=as.matrix(harmonic.train))
arma.humidity
```

```{r}
## compute the test statistics
testval <-
  as.numeric(arma.humidity$coef) / as.numeric(sqrt(diag(arma.humidity$var.coef)))

## print t-statistic
print(testval)

## print p-values
print(2*(1-pnorm(abs(testval))))

## print significant coefficients for significance level 0.05
which(abs(testval)>qnorm((1-0.05/2)))
```

```{r}
par(mfrow=c(2,2))
ts.plot(ts(residuals(arma.humidity), frequency = 365, start = c(2009,1)))
acf(residuals(arma.humidity), lag.max = 40)
acf(residuals(arma.humidity)^2, lag.max = 40)
qqnorm(residuals(arma.humidity))
qqline(residuals(arma.humidity))

#perform shapiro-wilk test
shapiro.test(residuals(arma.humidity))
```
### Results

For all 3 models we see the similar results: 
1) ACF plot of residuals indicates that the residuals aren't correlated
2) ACF plot of Squared residuals indicates that the squared residuals are correlated, so we conclude that heteroskedasticity is present in the residuals.
3) Shapiro-Wilk normality test shows that the residuals are not normally distributed because it rejects the null hypothesis of normal distribution. The QQ plot also shows heavier tails than for normal distribution. We conclude that the residuals does not follow normal distribution, which is required for model fitting using MLE. We conclude that our models aren't the good fit. 



### Prediction
```{r, eval = FALSE}
prediction.p.arima <- data.frame(Inf, Inf, Inf)
names(prediction.p.arima) <- c('prediction', 'lower', 'upper')
prediction.t.arima <- data.frame(Inf, Inf, Inf)
names(prediction.t.arima) <- c('prediction', 'lower', 'upper')
prediction.h.arima <- data.frame(Inf, Inf, Inf)
names(prediction.h.arima) <- c('prediction', 'lower', 'upper')

for (i in 1:6) {
  data <- daily.training.data
  new.xreg <- harmonic.test[(1 + (i - 1)*7): (i*7),]
  if (i >= 2) {
    data <- rbind(data, daily.testing.data[c(1:((i - 1)*7)),])
  }

  arma.p <- Arima(data$pressure,order=c(4,1,6), 
                  xreg=as.matrix(harmonic.all[1:nrow(data),]))
  arma.pred.p <- predict(arma.p, n.ahead = 7, newxreg = as.matrix(new.xreg))
  
  lb <- arma.pred.p$pred - 1.96 * arma.pred.p$se
  ub <- arma.pred.p$pred + 1.96 * arma.pred.p$se
  temp <- data.frame('prediction' = arma.pred.p$pred, 'lower' = lb, 'upper' = ub)
  prediction.p.arima <- rbind(prediction.p.arima, temp)
  
  arma.t <- Arima(data$temperature,order=c(8,1,4), 
                  xreg=as.matrix(harmonic.all[1:nrow(data),]))
  arma.pred.t <- predict(arma.t, n.ahead = 7, newxreg = as.matrix(new.xreg))
  
  lb <- arma.pred.t$pred - 1.96 * arma.pred.t$se
  ub <- arma.pred.t$pred + 1.96 * arma.pred.t$se
  temp <- data.frame('prediction' = arma.pred.t$pred, 'lower' = lb, 'upper' = ub)
  prediction.t.arima <- rbind(prediction.t.arima, temp)
  
  arma.h <- Arima(data$humidity,order=c(5,0,1), 
                  xreg=as.matrix(harmonic.all[1:nrow(data),]))
  arma.pred.h <- predict(arma.h, n.ahead = 7, newxreg = as.matrix(new.xreg))
  
  lb <- arma.pred.h$pred - 1.96 * arma.pred.h$se
  ub <- arma.pred.h$pred + 1.96 * arma.pred.h$se
  temp <- data.frame('prediction' = arma.pred.h$pred, 'lower' = lb, 'upper' = ub)
  prediction.h.arima <- rbind(prediction.h.arima, temp)
}
prediction.p.arima <- prediction.p.arima[-1,]
prediction.p.arima$date <- daily.testing.data$date

prediction.t.arima <- prediction.t.arima[-1,]
prediction.t.arima$date <- daily.testing.data$date

prediction.h.arima <- prediction.h.arima[-1,]
prediction.h.arima$date <- daily.testing.data$date

armax.prediction <- list(prediction.p.arima, prediction.t.arima, prediction.h.arima)
save(armax.prediction, file = 'armax-prediction.RData')
```

### Prediction Plots
```{r}

load('armax-prediction.RData')
prediction.p.armax <- armax.prediction[[1]]
prediction.t.armax <- armax.prediction[[2]]
prediction.h.armax <- armax.prediction[[3]]


plot(daily.testing.data$date, daily.testing.data$pressure, type = 'l', ylim = c(970,1020), main = 'Pressure Prediction', ylab = 'Pressure', xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.p.armax$prediction, type = 'l', col = 'red', ylim = c(970,1020), ylab = '', lwd = 1.5, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.p.armax$lower, type = 'l', col = 'blue', ylim = c(970,1020), ylab = '', lwd = 1.5, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.p.armax$upper, type = 'l', col = 'blue', ylim = c(970,1020), ylab = '', lwd = 1.5, xlab = 'Date')

plot(daily.testing.data$date, daily.testing.data$temperature, type = 'l', ylim = c(264,289), main = 'Temperature Prediction', ylab = 'Temperature', xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.t.armax$prediction, type = 'l', col = 'red', ylim = c(264,289), ylab = '', lwd = 1.5, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.t.armax$lower, type = 'l', col = 'blue', ylim = c(264,289), ylab = '', lwd = 1.5, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.t.armax$upper, type = 'l', col = 'blue', ylim = c(264,289), ylab = '', lwd = 1.5, xlab = 'Date')

plot(daily.testing.data$date, daily.testing.data$humidity, type = 'l', ylim = c(0.5,8), main = 'Humidity Prediction', ylab = 'Humidity', xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.h.armax$prediction, type = 'l', col = 'red', ylim = c(0.5,8), ylab = '', lwd = 1.5, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.h.armax$lower, type = 'l', col = 'blue', ylim = c(0.5,8), ylab = '', lwd = 1.5, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.h.armax$upper, type = 'l', col = 'blue', ylim = c(0.5,8), ylab = '', lwd = 1.5, xlab = 'Date')


```


## ARMA-GARCH for modeling pressure
```{r, eval = FALSE}
# We take order of ARMA equal to (4,1,6)
# Find order for GARCH
test_modelAGG <- function(m,n){
    spec = ugarchspec(variance.model=list(garchOrder=c(m,n)),
                      mean.model=list(armaOrder=c(4,1,6),
                                      external.regressors = as.matrix(harmonic.train),
                                      include.mean=T), distribution.model="std")
    fit = ugarchfit(spec, daily.pressure.train.ts, solver = 'hybrid')
    current.aic = infocriteria(fit)[1]
    df = data.frame(m,n,current.aic)
    names(df) <- c("m","n","AIC")
    return(df)
}

ordersAGG = data.frame(Inf,Inf,Inf)
names(ordersAGG) <- c("m","n","AIC")

for (m in 0:2){
    for (n in 0:2){
        possibleError <- tryCatch(
            ordersAGG<-rbind(ordersAGG,test_modelAGG(m,n)),
            error=function(e) e
        )
        if(inherits(possibleError, "error")) next
    }
}
ordersAGG <- ordersAGG[order(-ordersAGG$AIC),]
tail(ordersAGG)
```


```{r, eval = FALSE}
# Update ARMA using GARCH = (2,2)
test_modelAGA <- function(p,q){
    spec = ugarchspec(variance.model=list(garchOrder=c(1,1)),
                      mean.model=list(armaOrder=c(p,q),
                                      external.regressors = as.matrix(harmonic.train),
                                      include.mean=T),
                      distribution.model="std")
    fit = ugarchfit(spec, daily.pressure.train.ts, solver = 'hybrid')
    current.aic = infocriteria(fit)[1]
    df = data.frame(p,q,current.aic)
    names(df) <- c("p","q","AIC")
    return(df)
}

ordersAGA = data.frame(Inf,Inf,Inf)
names(ordersAGA) <- c("p","q","AIC")
for (p in 0:7){
    for (q in 0:7){1
              ordersAGA<-rbind(ordersAGA,test_modelAGA(p,q))
    }
}
ordersAGA <- ordersAGA[order(-ordersAGA$AIC),]
tail(ordersAGA)
```

```{r, eval = FALSE}
# Update order for GARCH using ARMA (6,5s)
test_modelAGG <- function(m,n){
    spec = ugarchspec(variance.model=list(garchOrder=c(m,n)),
                      mean.model=list(armaOrder=c(6,5),
                                      external.regressors = as.matrix(harmonic.train),
                                      include.mean=T), distribution.model="std")
    fit = ugarchfit(spec, daily.pressure.train.ts, solver = 'hybrid')
    current.aic = infocriteria(fit)[1]
    df = data.frame(m,n,current.aic)
    names(df) <- c("m","n","AIC")
    return(df)
}

ordersAGG = data.frame(Inf,Inf,Inf)
names(ordersAGG) <- c("m","n","AIC")

for (m in 0:2){
    for (n in 0:2){
        possibleError <- tryCatch(
            ordersAGG<-rbind(ordersAGG,test_modelAGG(m,n)),
            error=function(e) e
        )
        if(inherits(possibleError, "error")) next
    }
}
ordersAGG <- ordersAGG[order(-ordersAGG$AIC),]
tail(ordersAGG)
```

The final iteration shows that the optimal orders for modeling the temperature are (6,5)x(1,1).

```{r}
spec.1 = ugarchspec(variance.model=list(garchOrder=c(1,1)),
                 mean.model=list(armaOrder=c(6,5),
                                 external.regressors = as.matrix(harmonic.train),
                                  include.mean=T), distribution.model="std")
pressure.arma.garch<-ugarchfit(spec.1,daily.pressure.train.ts,solver='hybrid')
pressure.arma.garch
```

```{r}
par(mfrow=c(2,2))
ts.plot(ts(residuals(pressure.arma.garch), frequency = 365, start = c(2009,1)))
acf(residuals(pressure.arma.garch), lag.max = 40)
acf(residuals(pressure.arma.garch)^2, lag.max = 40)
qqnorm(residuals(pressure.arma.garch))
qqline(residuals(pressure.arma.garch))
```

## ARMA-GARCH for modeling temperature
```{r, eval = FALSE}
# We take order of ARMA equal to (8,1,4)
# Find order for GARCH
test_modelAGG <- function(m,n){
    spec = ugarchspec(variance.model=list(garchOrder=c(m,n)),
                      mean.model=list(armaOrder=c(8,1,4),
                                      external.regressors = as.matrix(harmonic.train),
                                      include.mean=T), distribution.model="std")
    fit = ugarchfit(spec, daily.temp.train.ts, solver = 'hybrid')
    current.aic = infocriteria(fit)[1]
    df = data.frame(m,n,current.aic)
    names(df) <- c("m","n","AIC")
    return(df)
}

ordersAGG = data.frame(Inf,Inf,Inf)
names(ordersAGG) <- c("m","n","AIC")

for (m in 0:2){
    for (n in 0:2){
        possibleError <- tryCatch(
            ordersAGG<-rbind(ordersAGG,test_modelAGG(m,n)),
            error=function(e) e
        )
        if(inherits(possibleError, "error")) next
    }
}
ordersAGG <- ordersAGG[order(-ordersAGG$AIC),]
tail(ordersAGG)
```

```{r, eval = FALSE}
# Update ARMA using GARCH = (2,0)
test_modelAGA <- function(p,q){
    spec = ugarchspec(variance.model=list(garchOrder=c(2,0)),
                      mean.model=list(armaOrder=c(p,q),
                                      external.regressors = as.matrix(harmonic.train),
                                      include.mean=T),
                      distribution.model="std")
    fit = ugarchfit(spec, daily.temp.train.ts, solver = 'hybrid')
    current.aic = infocriteria(fit)[1]
    df = data.frame(p,q,current.aic)
    names(df) <- c("p","q","AIC")
    return(df)
}

ordersAGA = data.frame(Inf,Inf,Inf)
names(ordersAGA) <- c("p","q","AIC")
for (p in 0:7){
    for (q in 0:7){
        possibleError <- tryCatch(
            ordersAGA<-rbind(ordersAGA,test_modelAGA(p,q)),
            error=function(e) e
        )
        if(inherits(possibleError, "error")) next
    }
}
ordersAGA <- ordersAGA[order(-ordersAGA$AIC),]
tail(ordersAGA)
```

```{r, eval = FALSE}
# We take order of ARMA equal to (6,5)
# Find order for GARCH
test_modelAGG <- function(m,n){
    spec = ugarchspec(variance.model=list(garchOrder=c(m,n)),
                      mean.model=list(armaOrder=c(6,5),
                                      external.regressors = as.matrix(harmonic.train),
                                      include.mean=T), distribution.model="std")
    fit = ugarchfit(spec, daily.temp.train.ts, solver = 'hybrid')
    current.aic = infocriteria(fit)[1]
    df = data.frame(m,n,current.aic)
    names(df) <- c("m","n","AIC")
    return(df)
}

ordersAGG = data.frame(Inf,Inf,Inf)
names(ordersAGG) <- c("m","n","AIC")

for (m in 0:2){
    for (n in 0:2){
        possibleError <- tryCatch(
            ordersAGG<-rbind(ordersAGG,test_modelAGG(m,n)),
            error=function(e) e
        )
        if(inherits(possibleError, "error")) next
    }
}
ordersAGG <- ordersAGG[order(-ordersAGG$AIC),]
tail(ordersAGG)
```

```{r, eval = FALSE}
# Update ARMA using GARCH = (1,1)
test_modelAGA <- function(p,q){
    spec = ugarchspec(variance.model=list(garchOrder=c(1,1)),
                      mean.model=list(armaOrder=c(p,q),
                                      external.regressors = as.matrix(harmonic.train),
                                      include.mean=T),
                      distribution.model="std")
    fit = ugarchfit(spec, daily.temp.train.ts, solver = 'hybrid')
    current.aic = infocriteria(fit)[1]
    df = data.frame(p,q,current.aic)
    names(df) <- c("p","q","AIC")
    return(df)
}

ordersAGA = data.frame(Inf,Inf,Inf)
names(ordersAGA) <- c("p","q","AIC")
for (p in 0:7){
    for (q in 0:7){
        possibleError <- tryCatch(
            ordersAGA<-rbind(ordersAGA,test_modelAGA(p,q)),
            error=function(e) e
        )
        if(inherits(possibleError, "error")) next
    }
}
ordersAGA <- ordersAGA[order(-ordersAGA$AIC),]
tail(ordersAGA)
```

The final iteration shows that the optimal orders for modeling the temperature are (6,5)x(1,1).

```{r}
spec.2 = ugarchspec(variance.model=list(garchOrder=c(1,1)),
                 mean.model=list(armaOrder=c(6,5),
                                 external.regressors = as.matrix(harmonic.train),
                                  include.mean=T), distribution.model="std")
temp.arma.garch<-ugarchfit(spec.2,daily.temp.train.ts,solver='hybrid')
temp.arma.garch
```


```{r}
par(mfrow=c(2,2))
ts.plot(ts(residuals(temp.arma.garch), frequency = 365, start = c(2009,1)))
acf(residuals(temp.arma.garch), lag.max = 40)
acf(residuals(temp.arma.garch)^2, lag.max = 40)
qqnorm(residuals(temp.arma.garch))
qqline(residuals(temp.arma.garch))
```



## ARMA-GARCH for modeling humidity
```{r, eval = FALSE}
# We take order of ARMA equal to (6,0,5)
# Find order for GARCH
test_modelAGG <- function(m,n){
    spec = ugarchspec(variance.model=list(garchOrder=c(m,n)),
                      mean.model=list(armaOrder=c(6,5),
                                      external.regressors = as.matrix(harmonic.train),
                                      include.mean=T), distribution.model="std")
    fit = ugarchfit(spec, daily.humidity.train.ts, solver = 'hybrid')
    current.aic = infocriteria(fit)[1]
    df = data.frame(m,n,current.aic)
    names(df) <- c("m","n","AIC")
    return(df)
}

ordersAGG = data.frame(Inf,Inf,Inf)
names(ordersAGG) <- c("m","n","AIC")

for (m in 0:2){
    for (n in 0:2){
        possibleError <- tryCatch(
            ordersAGG<-rbind(ordersAGG,test_modelAGG(m,n)),
            error=function(e) e
        )
        if(inherits(possibleError, "error")) next
    }
}
ordersAGG <- ordersAGG[order(-ordersAGG$AIC),]
tail(ordersAGG)
```

```{r, eval = FALSE}
# Update ARMA using GARCH = (2,2)
test_modelAGA <- function(p,q){
    spec = ugarchspec(variance.model=list(garchOrder=c(2,2)),
                      mean.model=list(armaOrder=c(p,q),
                                      external.regressors = as.matrix(harmonic.train),
                                      include.mean=T),
                      distribution.model="std")
    fit = ugarchfit(spec, daily.humidity.train.ts, solver = 'hybrid')
    current.aic = infocriteria(fit)[1]
    df = data.frame(p,q,current.aic)
    names(df) <- c("p","q","AIC")
    return(df)
}

ordersAGA = data.frame(Inf,Inf,Inf)
names(ordersAGA) <- c("p","q","AIC")
for (p in 0:7){
    for (q in 0:7){
        possibleError <- tryCatch(
            ordersAGA<-rbind(ordersAGA,test_modelAGA(p,q)),
            error=function(e) e
        )
        if(inherits(possibleError, "error")) next
    }
}
ordersAGA <- ordersAGA[order(-ordersAGA$AIC),]
tail(ordersAGA)
```

```{r, eval = FALSE}
# Update order for GARCH using ARMA (4,4)
test_modelAGG <- function(m,n){
    spec = ugarchspec(variance.model=list(garchOrder=c(m,n)),
                      mean.model=list(armaOrder=c(4,4),
                                      external.regressors = as.matrix(harmonic.train),
                                      include.mean=T), distribution.model="std")
    fit = ugarchfit(spec, daily.humidity.train.ts, solver = 'hybrid')
    current.aic = infocriteria(fit)[1]
    df = data.frame(m,n,current.aic)
    names(df) <- c("m","n","AIC")
    return(df)
}

ordersAGG = data.frame(Inf,Inf,Inf)
names(ordersAGG) <- c("m","n","AIC")

for (m in 0:2){
    for (n in 0:2){
        possibleError <- tryCatch(
            ordersAGG<-rbind(ordersAGG,test_modelAGG(m,n)),
            error=function(e) e
        )
        if(inherits(possibleError, "error")) next
    }
}
ordersAGG <- ordersAGG[order(-ordersAGG$AIC),]
tail(ordersAGG)
```

The final iteration shows that the optimal orders for modeling the Humidity are (4,4)x(2,2).

```{r}
spec.3 = ugarchspec(variance.model=list(garchOrder=c(2,2)), 
                    mean.model=list(armaOrder=c(4,4), 
                                    external.regressors = as.matrix(harmonic.train),
                                    include.mean=T), 
                    distribution.model="std")
hum.arma.garch<-ugarchfit(spec.3,daily.humidity.train.ts,solver='hybrid')
hum.arma.garch
```

```{r}
par(mfrow=c(2,2))
ts.plot(ts(residuals(hum.arma.garch), frequency = 365, start = c(2009,1)))
acf(residuals(hum.arma.garch), lag.max = 40)
acf(residuals(hum.arma.garch)^2, lag.max = 40)
qqnorm(residuals(hum.arma.garch))
qqline(residuals(hum.arma.garch))
```


## Arma-Garch Prediction
```{r, eval = FALSE}
prediction.p.arma.garch <- data.frame(Inf, Inf, Inf)
names(prediction.p.arma.garch) <- c('prediction', 'lower', 'upper')
prediction.t.arma.garch <- data.frame(Inf, Inf, Inf)
names(prediction.t.arma.garch) <- c('prediction', 'lower', 'upper')
prediction.h.arma.garch <- data.frame(Inf, Inf, Inf)
names(prediction.h.arma.garch) <- c('prediction', 'lower', 'upper')

for (i in 1:6) {
  data <- daily.training.data
  if (i >= 2) {
    data <- rbind(data, daily.testing.data[c(1:((i - 1)*7)),])
  }
  
  spec.p = ugarchspec(variance.model=list(garchOrder=c(1,1)), 
                      mean.model=list(armaOrder=c(6,5), 
                                      external.regressors = as.matrix(harmonic.all[c(1:nrow(data)),]),
                                      include.mean=T), 
                      distribution.model="std")
  arma.garch.p <-ugarchfit(spec.p, data$pressure,solver='hybrid')
  fore <- ugarchforecast(arma.garch.p, n.ahead = 7)
  fore <- fore@forecast
  temp <- data.frame(fore$seriesFor, 
                     fore$seriesFor - 1.96 * fore$sigmaFor, 
                     fore$seriesFor + 1.96 * fore$sigmaFor)
  names(temp) <- c('prediction', 'lower', 'upper')
  prediction.p.arma.garch <- rbind(prediction.p.arma.garch, temp)
  
  
  spec.t = ugarchspec(variance.model=list(garchOrder=c(1,1)), 
                      mean.model=list(armaOrder=c(6,5), 
                                      external.regressors = as.matrix(harmonic.all[c(1:nrow(data)),]),
                                      include.mean=T), 
                      distribution.model="std")
  arma.garch.t <-ugarchfit(spec.t, data$temperature,solver='hybrid')
  fore <- ugarchforecast(arma.garch.t, n.ahead = 7)
  fore <- fore@forecast
  temp <- data.frame('prediction' = fore$seriesFor, 
                     'lower' = fore$seriesFor - 1.96 * fore$sigmaFor, 
                     'upper' = fore$seriesFor + 1.96 * fore$sigmaFor)
  names(temp) <- c('prediction', 'lower', 'upper')
  prediction.t.arma.garch <- rbind(prediction.t.arma.garch, temp)
  
  spec.h = ugarchspec(variance.model=list(garchOrder=c(2,2)), 
                      mean.model=list(armaOrder=c(4,4), 
                                      external.regressors = as.matrix(harmonic.all[c(1:nrow(data)),]),
                                      include.mean=T), 
                      distribution.model="std")
  arma.garch.h <-ugarchfit(spec.h, data$humidity,solver='hybrid')
  fore <- ugarchforecast(arma.garch.h, n.ahead = 7)
  fore <- fore@forecast
  temp <- data.frame('prediction' = fore$seriesFor, 
                     'lower' = fore$seriesFor - 1.96 * fore$sigmaFor, 
                     'upper' = fore$seriesFor + 1.96 * fore$sigmaFor)
  names(temp) <- c('prediction', 'lower', 'upper')
  prediction.h.arma.garch <- rbind(prediction.h.arma.garch, temp)
  
}
prediction.p.arma.garch <- prediction.p.arma.garch[-1,]
prediction.p.arma.garch$date <- daily.testing.data$date

prediction.t.arma.garch <- prediction.t.arma.garch[-1,]
prediction.t.arma.garch$date <- daily.testing.data$date

prediction.h.arma.garch <- prediction.h.arma.garch[-1,]
prediction.h.arma.garch$date <- daily.testing.data$date

arma.garch.prediction <- list(prediction.p.arma.garch, prediction.t.arma.garch, prediction.h.arma.garch)
save(arma.garch.prediction, file = 'arma-garch-prediction.RData')
```


### Prediction Plots
```{r}
load('arma-garch-prediction.RData')
prediction.p.arma.garch <- arma.garch.prediction[[1]]
prediction.t.arma.garch <- arma.garch.prediction[[2]]
prediction.h.arma.garch <- arma.garch.prediction[[3]]

plot(daily.testing.data$date, daily.testing.data$pressure, type = 'l', ylim = c(970,1020), main = 'Pressure Prediction', ylab = 'Pressure', xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.p.arma.garch$prediction, type = 'l', col = 'red', ylim = c(970,1020), ylab = '', cex = 0.6, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.p.arma.garch$lower, type = 'l', col = 'blue', ylim = c(970,1020), ylab = '', cex = 0.6, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.p.arma.garch$upper, type = 'l', col = 'blue', ylim = c(970,1020), ylab = '', cex = 0.6, xlab = 'Date')

plot(daily.testing.data$date, daily.testing.data$temperature, type = 'l', ylim = c(264,289), main = 'Temperature Prediction', ylab = 'Temperature', xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.t.arma.garch$prediction, type = 'l', col = 'red', ylim = c(264,289), ylab = '', cex = 0.6, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.t.arma.garch$lower, type = 'l', col = 'blue', ylim = c(264,289), ylab = '', cex = 0.6, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.t.arma.garch$upper, type = 'l', col = 'blue', ylim = c(264,289), ylab = '', cex = 0.6, xlab = 'Date')

plot(daily.testing.data$date, daily.testing.data$humidity, type = 'l', ylim = c(0.5,8), main = 'Humidity Prediction', ylab = 'Humidity', xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.h.arma.garch$prediction, type = 'l', col = 'red', ylim = c(0.5,8), ylab = '', cex = 0.6, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.h.arma.garch$lower, type = 'l', col = 'blue', ylim = c(0.5,8), ylab = '', cex = 0.6, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.h.arma.garch$upper, type = 'l', col = 'blue', ylim = c(0.5,8), ylab = '', cex = 0.6, xlab = 'Date')
```
# VAR modeling

```{r}
train.data <- cbind(daily.pressure.train.ts, daily.temp.train.ts, daily.humidity.train.ts)
test.data <- cbind(daily.pressure.test.ts, daily.temp.test.ts, daily.humidity.test.ts)
colnames(train.data) <- c("pressure", "temperature", "humidity")
var.select<-VARselect(train.data, exogen=harmonic.train, type="both")
var.select$selection
```

```{r}
var1<-VAR(train.data,p=3, exogen=harmonic.train, type="both")
summary(var1)
```

```{r, eval=FALSE}
prediction.p.var <- data.frame(Inf, Inf, Inf)
names(prediction.p.var) <- c('fcst', 'lower', 'upper')
prediction.t.var <- data.frame(Inf, Inf, Inf)
names(prediction.t.var) <- c('fcst', 'lower', 'upper')
prediction.h.var <- data.frame(Inf, Inf, Inf)
names(prediction.h.var) <- c('fcst', 'lower', 'upper')

for (i in 1:6) {
  data <- train.data
  if (i >= 2) {
    data <- rbind(data, test.data[c(1:((i - 1)*7)),])
  }
  exo <- harmonic.all[1:nrow(data),]
  new.exo <- harmonic.test[(1 + (i - 1) * 7):(i * 7),]
  
  varx<-VAR(data,p=3, exogen=exo, type="both")
  pred <- predict(varx, n.ahead = 7, ci = 0.95, dumvar = new.exo)
  pred <- pred$fcst
  prediction.p.var <- rbind(prediction.p.var, pred$pressure[,1:3])
  prediction.t.var <- rbind(prediction.t.var, pred$temperature[,1:3])
  prediction.h.var <- rbind(prediction.h.var, pred$humidity[,1:3])
}

prediction.p.var <- prediction.p.var[-1,]
prediction.p.var$date <- daily.testing.data$date

prediction.t.var <- prediction.t.var[-1,]
prediction.t.var$date <- daily.testing.data$date

prediction.h.var <- prediction.h.var[-1,]
prediction.h.var$date <- daily.testing.data$date

varx.prediction <- list(prediction.p.var, prediction.t.var, prediction.h.var)
save(varx.prediction, file = 'varx-prediction.RData')
```

### Prediction Plots
```{r}
load('varx-prediction.RData')
prediction.p.varx <- varx.prediction[[1]]
prediction.t.varx <- varx.prediction[[2]]
prediction.h.varx <- varx.prediction[[3]]

plot(daily.testing.data$date, daily.testing.data$pressure, type = 'l', ylim = c(970,1020), main = 'Pressure Prediction', ylab = 'Pressure', xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.p.varx$fcst, type = 'l', col = 'red', ylim = c(970,1020), ylab = '', cex = 0.6, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.p.varx$lower, type = 'l', col = 'blue', ylim = c(970,1020), ylab = '', cex = 0.6, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.p.varx$upper, type = 'l', col = 'blue', ylim = c(970,1020), ylab = '', cex = 0.6, xlab = 'Date')

plot(daily.testing.data$date, daily.testing.data$temperature, type = 'l', ylim = c(264,289), main = 'Temperature Prediction', ylab = 'Temperature', xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.t.varx$fcst, type = 'l', col = 'red', ylim = c(264,289), ylab = '', cex = 0.6, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.t.varx$lower, type = 'l', col = 'blue', ylim = c(264,289), ylab = '', cex = 0.6, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.t.varx$upper, type = 'l', col = 'blue', ylim = c(264,289), ylab = '', cex = 0.6, xlab = 'Date')

plot(daily.testing.data$date, daily.testing.data$humidity, type = 'l', ylim = c(0.5,8), main = 'Humidity Prediction', ylab = 'Humidity', xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.h.varx$fcst, type = 'l', col = 'red', ylim = c(0.5,8), ylab = '', cex = 0.6, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.h.varx$lower, type = 'l', col = 'blue', ylim = c(0.5,8), ylab = '', cex = 0.6, xlab = 'Date')
par(new = T)
plot(daily.testing.data$date, prediction.h.varx$upper, type = 'l', col = 'blue', ylim = c(0.5,8), ylab = '', cex = 0.6, xlab = 'Date')
```

*Results*
Looking at the roots of the characteristic polynomial, we see that their absolute values are less than 1, which indicates that our VAR model is stable.

Looking at the  output of the models for all 3 weather components we conclude the following:
-trend isn't statistically significant for all 3 weather components. 
-harmonic seasonality coefficients aren't statistically significant for the first model (for pressure). However, they are statistically significant for models for temperature and humidity.
-for pressure: lead lag relationship with temperature at lag 1, lag 2 and lag 3, lead lag relationship with humidity only at lag 3. Lead lag relationship with the time series itself is statistically significant at lag 1,2 and 3.
-for temperature: lead lag relationship with pressure at lag 1, lag 2 and lag 3, lead lag relationship with humidity only at lag 3. Lead lag relationship with the time series itself is statistically significant at lag 1,2 and 3.
-for humidity: lead lag relationship with temperature at lag 1 and lag 3, lead lag relationship with pressure at lag 1 and lag 3. Lead lag relationship with the time series itself is statistically significant at lag 1,2 and 3.


```{r}
var.restrict.model=restrict(var1)  
summary(var.restrict.model)
```

# Forecasting comparison
```{r}
col = wes_palette(n = 5, name = 'FantasticFox1')
col <- col[-4]
daily.testing.data$date <- as.POSIXct(daily.testing.data$date)
point_size = 1.5
line_width = 2

# Plot with custom x-axis labels
plot(daily.testing.data$date, daily.testing.data$pressure, type = 'l', ylim = c(960,1020), main = 'Pressure Prediction', ylab = 'Pressure', xlab = 'Date', xaxt = 'n')
axis(1, at = seq(from = min(daily.testing.data$date, na.rm = TRUE), to = max(daily.testing.data$date, na.rm = TRUE), by = "1 month"), labels = format(seq(from = min(daily.testing.data$date, na.rm = TRUE), to = max(daily.testing.data$date, na.rm = TRUE), by = "1 month"), "%Y-%m-%d"))
points(daily.testing.data$date, gam.prediction$pressure, col = col[1], cex = point_size)
lines(daily.testing.data$date, prediction.p.gam$lower, col = col[1], lwd = line_width)
lines(daily.testing.data$date, prediction.p.gam$upper, col = col[1], lwd = line_width)
points(daily.testing.data$date, arma.garch.prediction[[1]]$prediction, col = col[2], cex = point_size)
lines(daily.testing.data$date, prediction.p.arma.garch$lower, col = col[2], lwd = line_width)
lines(daily.testing.data$date, prediction.p.arma.garch$upper, col = col[2], lwd = line_width)
points(daily.testing.data$date, varx.prediction[[1]]$fcst, col = col[3], cex = point_size)
lines(daily.testing.data$date, prediction.p.varx$lower, col = col[3], lwd = line_width)
lines(daily.testing.data$date, prediction.p.varx$upper, col = col[3], lwd = line_width)
points(daily.testing.data$date, armax.prediction[[1]]$prediction, col = col[4], cex = point_size)
lines(daily.testing.data$date, prediction.p.armax$lower, col = col[4], lwd = line_width)
lines(daily.testing.data$date, prediction.p.armax$upper, col = col[4], lwd = line_width)
legend('bottomleft', legend = c('observation', 'Nonpar.Trend+ANOVA S.', 
                                 'ARMA-GARCH', 'VARX', 'ARMAX'), col = c('black', col), lty = 1)

daily.testing.data$date <- as.POSIXct(daily.testing.data$date)
plot(daily.testing.data$date, daily.testing.data$temperature, type = 'l', ylim = c(260,289), main = 'Temperature Prediction', ylab = 'Temperature', xlab = 'Date', xaxt = 'n')
axis(1, at = seq(from = min(daily.testing.data$date, na.rm = TRUE), 
                 to = max(daily.testing.data$date, na.rm = TRUE), 
                 by = "1 month"), 
    labels = format(seq(from = min(daily.testing.data$date, na.rm = TRUE),
                        to = max(daily.testing.data$date, na.rm = TRUE),
                        by = "1 month"), "%Y-%m-%d"))
points(daily.testing.data$date, gam.prediction$temperature, col = col[1], cex = point_size, xlab = 'Date')
lines(daily.testing.data$date, prediction.t.gam$lower, col = col[1], lwd = line_width)
lines(daily.testing.data$date, prediction.t.gam$upper, col = col[1], lwd = line_width)
points(daily.testing.data$date, arma.garch.prediction[[2]]$prediction, col = col[2], cex = point_size, xlab = 'Date')
lines(daily.testing.data$date, prediction.t.arma.garch$lower, col = col[2], lwd = line_width)
lines(daily.testing.data$date, prediction.t.arma.garch$upper, col = col[2], lwd = line_width)
points(daily.testing.data$date, varx.prediction[[2]]$fcst, col = col[3], cex = point_size, xlab = 'Date')
lines(daily.testing.data$date, prediction.t.varx$lower, col = col[3], lwd = line_width)
lines(daily.testing.data$date, prediction.t.varx$upper, col = col[3], lwd = line_width)
points(daily.testing.data$date, armax.prediction[[2]]$prediction, col = col[4], cex = point_size, xlab = 'Date')
lines(daily.testing.data$date, prediction.t.armax$lower, col = col[4], lwd = line_width)
lines(daily.testing.data$date, prediction.t.armax$upper, col = col[4], lwd = line_width)
legend('bottomleft', legend = c('observation', 'Nonpar.Trend+ANOVA S.', 
                                 'ARMA-GARCH', 'VARX', 'ARMAX'), col = c('black', col), lty =1)

plot(daily.testing.data$date, daily.testing.data$humidity, type = 'l', ylim = c(0,8), main = 'Humidity Prediction', ylab = 'Humidity', xlab = 'Date', xaxt = 'n')
axis(1, at = seq(from = min(daily.testing.data$date, na.rm = TRUE), 
                 to = max(daily.testing.data$date, na.rm = TRUE), 
                 by = "1 month"), 
    labels = format(seq(from = min(daily.testing.data$date, na.rm = TRUE),
                        to = max(daily.testing.data$date, na.rm = TRUE),
                        by = "1 month"), "%Y-%m-%d"))
points(daily.testing.data$date, gam.prediction$humidity, col = col[1], cex = point_size, xlab = 'Date')
lines(daily.testing.data$date, prediction.h.gam$lower, col = col[1], lwd = line_width)
lines(daily.testing.data$date, prediction.h.gam$upper, col = col[1], lwd = line_width)
points(daily.testing.data$date, arma.garch.prediction[[3]]$prediction, col = col[2], cex = point_size, xlab = 'Date')
lines(daily.testing.data$date, prediction.h.arma.garch$lower, col = col[2], lwd = line_width)
lines(daily.testing.data$date, prediction.h.arma.garch$upper, col = col[2], lwd = line_width)
points(daily.testing.data$date, varx.prediction[[3]]$fcst, col = col[3], cex = point_size, xlab = 'Date')
lines(daily.testing.data$date, prediction.h.varx$lower, col = col[3], lwd = line_width)
lines(daily.testing.data$date, prediction.h.varx$upper, col = col[3], lwd = line_width)
points(daily.testing.data$date, armax.prediction[[3]]$prediction, col = col[4], cex = point_size, xlab = 'Date')
lines(daily.testing.data$date, prediction.h.armax$lower, col = col[4], lwd = line_width)
lines(daily.testing.data$date, prediction.h.armax$upper, col = col[4], lwd = line_width)
legend('bottomleft', legend = c('observation', 'Nonpar.Trend+ANOVA S.', 
                                 'ARMA-GARCH', 'VARX', 'ARMAX'), col = c('black', col), lty = 1)

```

# Forecasting Measures

## MAE
```{r}
gam.mae <- colMeans(abs(daily.testing.data[,2:4] - gam.prediction[,2:4]))

arma.garch.mae <- colMeans(abs(daily.testing.data[,2:4] - cbind(arma.garch.prediction[[1]]$prediction, arma.garch.prediction[[2]]$prediction,arma.garch.prediction[[3]]$prediction)))

varx.mae <- colMeans(abs(daily.testing.data[,2:4] - cbind(varx.prediction[[1]]$fcst, varx.prediction[[2]]$fcst,varx.prediction[[3]]$fcst)))

armax.mae <- colMeans(abs(daily.testing.data[,2:4] - cbind(armax.prediction[[1]]$prediction, armax.prediction[[2]]$prediction,armax.prediction[[3]]$prediction)))

mae <- rbind(gam.mae, arma.garch.mae, varx.mae, armax.mae)
rownames(mae) <- c('Nonparametric Trend + ANOVA Seasonality', 
                                 'ARMA-GARCH', 'VARX', 'ARMAX')
kable(mae, align = 'c', row.names = TRUE)
```

## PM
```{r}
gam.pm <- colSums((gam.prediction[,2:4] - daily.testing.data[,2:4])^2) / colSums((daily.testing.data[,2:4] - colMeans(daily.testing.data[,2:4]))^2)

arma.garch.pm <- colSums((cbind(arma.garch.prediction[[1]]$prediction, arma.garch.prediction[[2]]$prediction,arma.garch.prediction[[3]]$prediction) - daily.testing.data[,2:4])^2) / colSums((daily.testing.data[,2:4] - colMeans(daily.testing.data[,2:4]))^2)

varx.pm <- colSums((cbind(varx.prediction[[1]]$fcst, varx.prediction[[2]]$fcst,varx.prediction[[3]]$fcst) - daily.testing.data[,2:4])^2) / colSums((daily.testing.data[,2:4] - colMeans(daily.testing.data[,2:4]))^2)

armax.pm <- colSums((cbind(armax.prediction[[1]]$prediction, armax.prediction[[2]]$prediction,armax.prediction[[3]]$prediction) - daily.testing.data[,2:4])^2) / colSums((daily.testing.data[,2:4] - colMeans(daily.testing.data[,2:4]))^2)

pm <- rbind(gam.pm, arma.garch.pm, varx.pm, armax.pm)
rownames(pm) <- c('Nonparametric Trend + ANOVA Seasonality', 
                                 'ARMA-GARCH', 'VARX', 'ARMAX')
kable(pm, align = 'c', row.names = TRUE)
```








